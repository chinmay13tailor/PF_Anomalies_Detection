<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Low Power Factor Analysis Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Plotly (pinned) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <!-- PDF deps -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI',sans-serif;
      background:#EEEEEE;   /* background updated */
      margin:0;
      color:#333
    }
    .page{padding:2rem}

    /* Section 1: Controls box */
/* Controls box */
.filter-row{
  width:95%;
  margin:1rem auto;
  display:flex;
  flex-wrap:wrap;
  gap:1rem;
  align-items:flex-end;
  background:#fff;
  padding:1rem;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);

  position:sticky;   /* NEW */
  top:0;             /* sticks to top */
  z-index:1000;      /* stays above report content */
}

    label{font-weight:600;display:block;margin:0 0 .35rem}
    input,button{padding:.55rem .8rem;font-size:1rem;border:1px solid #d0d7de;border-radius:6px;background:#fff}
    button.primary{background:#1363df;color:#fff;border:0;font-weight:700;cursor:pointer}
    button.primary:hover{background:#0e4fb1}
    .status{margin-left:.5rem;color:#6a737d}

    /* --- Header (hidden in screen, shown in PDF) --- */
    .header{
      display:none;
      justify-content:space-between;flex-wrap:wrap;gap:1rem;
      border-bottom:1px solid #e5e7eb;padding-bottom:1rem
    }
    .company{font-weight:700;font-size:1.1rem}
    .meta{color:#555}

    /* Section 2: Report area */
    .report-box{
      width:95%;margin:1rem auto;padding:1rem;
      background:#fff;border-radius:10px;
      box-shadow:0 4px 14px rgba(0,0,0,.08);
    }

    .summary-row{width:95%;margin:1rem auto 0;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
    .kpi{background:#fff;border-radius:10px;padding:1rem 1.25rem;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .kpi .title{color:#666;font-size:.9rem}
    .kpi .value{font-size:2rem;font-weight:800}
    .kpi .sub{color:#666;margin-top:.25rem}
    .kpi.danger{background:#ffe0dd}

    .panel{width:95%;margin:1rem auto;background:#fff;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:1rem}
    .panel h3{margin:.2rem 0 1rem}

    .grid2{display:grid;grid-template-columns:1fr;gap:0.9rem}

    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff;table-layout:fixed}
    th,td{padding:.8rem 1rem;border-bottom:1px solid #eee;text-align:center;white-space:normal}
    thead th{background:#ffd700;color:#222}
    tbody tr:nth-child(even){background:#fafafa}

    .footer{
      width:95%; margin:1rem auto 0; display:grid;
      grid-template-columns:minmax(0,2fr) minmax(260px,1fr);
      gap:1rem; align-items:start;
    }
    .remarks textarea{
      width:100%; min-height:130px; resize:vertical;
      border:1px solid #d0d7de; border-radius:8px; padding:.6rem; background:#fff;
    }
    .sign{display:flex;flex-direction:column;gap:20px}
    .sign .line{width:100%; height:0; border-bottom:2px solid #333; margin-top:10px}

    @media (max-width:980px){
      .summary-row{grid-template-columns:1fr 1fr}
      .footer{grid-template-columns:1fr}
    }

    /* -------- PDF MODE -------- */
    body.pdf .header{display:flex !important;} /* show header only in PDF */
    body.pdf .pdf-page{
      width:294mm;background:#fff;margin:0 auto;padding:2mm 3mm;
    }
    body.pdf .panel{ padding:8px 10px; margin:8px auto; width:99%; }
    body.pdf .summary-row{ width:99%; gap:.6rem; }
    body.pdf .footer{ width:99%; gap:.6rem; }
  </style>
</head>
<body>
<div class="page" id="pageRoot">
  <!-- Section 1: Controls -->
  <div class="filter-row">
    <div>
      <label for="dateInput">Select Date</label>
      <input type="date" id="dateInput"/>
    </div>
    <div>
      <button id="btnGenerate" class="primary">Generate</button>
      <span class="status" id="status">Idle</span>
    </div>
    <div style="margin-left:auto">
      <button id="btnExport" class="primary" title="Download report as PDF">Export PDF</button>
    </div>
  </div>

  <!-- Section 2: Report -->
  <div class="report-box">
    <div id="printArea">
      <!-- PAGE 1 -->
      <section class="pdf-page" id="pdfPage1">
        <div class="header">
          <div>
            <div class="company" id="companyName">Pima Controls Pvt Ltd</div>
            <div id="companyAddress">Ahmedabad, India</div>
          </div>
          <div class="meta">
            <div><b>Report:</b> Low Power Factor Analysis Report</div>
            <div><b>Report Date:</b> <span id="reportDateLabel">—</span></div>
            <div><b>Generated:</b> <span id="generatedAt">—</span></div>
            <div><b>Device:</b> <span id="deviceShown">—</span></div>
          </div>
        </div>

        <div class="summary-row">
          <div class="kpi"><div class="title">Avg PF (window)</div><div class="value" id="kpiAvgPF">—</div></div>
          <div class="kpi"><div class="title">Min PF</div><div class="value" id="kpiMinPF">—</div><div class="sub" id="kpiMinPFTs">—</div></div>
          <div class="kpi"><div class="title">Duration PF &lt; 0.90</div><div class="value" id="kpiDurationLowPF">—</div></div>
          <div class="kpi danger"><div class="title">Estimated penalty (₹)</div><div class="value" id="kpiPenalty">—</div></div>
        </div>

        <div class="panel">
          <h3>PF Trend (with Active_Power & Reactive_Power)</h3>
          <div id="pfTrend" style="height:360px;"></div>
        </div>
      </section>

      <!-- PAGE 2 -->
      <section class="pdf-page" id="pdfPage2">
        <div class="grid2" id="page2Grid">
          <div class="panel">
            <h3>KWh vs KVArh</h3>
            <div id="energyBars" style="height:340px;"></div>
          </div>
          <div class="panel">
            <h3>PF vs kW</h3>
            <div id="pfScatter" style="height:340px;"></div>
          </div>
        </div>
      </section>

      <!-- PAGE 3 -->
      <section class="pdf-page" id="pdfPage3">
        <div class="panel">
          <h3>Events Table (PF &lt; 0.90)</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Start</th><th>End</th><th>Min PF</th>
                  <th>kW@minPF</th><th>kVAr@minPF</th><th>kVA@minPF</th><th>Duration (min)</th>
                </tr>
              </thead>
              <tbody id="eventsBody"><tr><td colspan="7">Click Generate</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="footer">
          <div class="remarks">
            <div><b>Remarks</b></div>
            <textarea placeholder="Engineer notes..."></textarea>
          </div>
          <div class="sign">
            <div>Reviewed by<div class="line"></div></div>
            <div>Checked by<div class="line"></div></div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  API_BASE_URL: "https://plantwiz.pimateck.in/api",
  KEYS: [
    "Meter_Run_Hourly",
    "Consumption_Hourly",
    "Runtime_Hourly",
    "Downtime_Hourly",
    "Idletime_Hourly",
    "Oee_Hourly"
  ],
  DEFAULT_DEVICE_ID: "81261350-b886-11f0-87ea-b9809c1a7a9e"   // ✅ your fixed device ID
};

const qs = new URLSearchParams(location.search);
const JWT = qs.get("token") || "";
const URL_DEVICE = qs.get("deviceId") || "";
const DEVICE_ID = URL_DEVICE || CONFIG.DEFAULT_DEVICE_ID;      // ✅ fallback to default

if (!JWT) alert("Missing token in URL (device ID is set to default).");

function num(v){ const n = Number(v); return Number.isFinite(n)?n:0; }
function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}); }

async function fetchHourlyData(){
  const end = Date.now();
  const start = end - 24*3600*1000;  // last 24 hours
  const url = `${CONFIG.API_BASE_URL}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries`
            + `?keys=${CONFIG.KEYS.join(",")}&startTs=${start}&endTs=${end}&limit=1000&agg=NONE`;
  const res = await fetch(url, { headers: { "X-Authorization": `Bearer ${JWT}` }});
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}

function mergeSeries(obj){
  const map = new Map();
  for(const [key,arr] of Object.entries(obj)){
    (arr||[]).forEach(p=>{
      const t = +p.ts;
      const row = map.get(t)||{ts:t};
      row[key] = num(p.value);
      map.set(t,row);
    });
  }
  return Array.from(map.values()).sort((a,b)=>a.ts-b.ts);
}

function renderKpis(rows){
  const totalFabric = rows.reduce((s,r)=>s+num(r.Meter_Run_Hourly),0);
  const totalRuntime = rows.reduce((s,r)=>s+num(r.Runtime_Hourly),0);
  const totalDowntime = rows.reduce((s,r)=>s+num(r.Downtime_Hourly),0);
  const totalIdle = rows.reduce((s,r)=>s+num(r.Idletime_Hourly),0);
  const totalEnergy = rows.reduce((s,r)=>s+num(r.Consumption_Hourly),0);
  const avgOee = rows.length?rows.reduce((s,r)=>s+num(r.Oee_Hourly),0)/rows.length:0;

  document.getElementById("fabricProduced").textContent = totalFabric.toFixed(0) + " m";
  document.getElementById("runtime").textContent = totalRuntime.toFixed(1);
  document.getElementById("downtime").textContent = totalDowntime.toFixed(1);
  document.getElementById("idle").textContent = totalIdle.toFixed(1);
  document.getElementById("energy").textContent = totalEnergy.toFixed(1);
  document.getElementById("oee").textContent = avgOee.toFixed(1) + " %";

  // Derived KPIs
  const avgSpeed = totalRuntime>0 ? (totalFabric / totalRuntime) : 0;
  const energyPerMeter = totalFabric>0 ? (totalEnergy / totalFabric) : 0;
  const shiftEfficiency = avgOee.toFixed(1);
  const prodList = rows.map(r=>r.Meter_Run_Hourly).filter(x=>x>0);
  const mean = prodList.reduce((s,x)=>s+x,0)/prodList.length;
  const sd = Math.sqrt(prodList.reduce((s,x)=>s+(x-mean)**2,0)/prodList.length);
  const consistency = mean? (sd/mean*100):0;

  document.getElementById("avgSpeed").textContent = avgSpeed.toFixed(1);
  document.getElementById("energyPerMeter").textContent = energyPerMeter.toFixed(3);
  document.getElementById("shiftEfficiency").textContent = shiftEfficiency + " %";
  document.getElementById("productionConsistency").textContent = consistency.toFixed(1) + " %";
}

function renderTable(rows){
  const tb=document.getElementById("hourlyTable");
  tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const cells=[
      fmtTime(r.ts),
      r.Meter_Run_Hourly?.toFixed(0),
      r.Runtime_Hourly?.toFixed(1),
      r.Downtime_Hourly?.toFixed(1),
      r.Idletime_Hourly?.toFixed(1),
      r.Consumption_Hourly?.toFixed(1),
      r.Oee_Hourly?.toFixed(1)
    ];
    cells.forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v??"—";
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

function renderChart(rows){
  if(!rows.length){ Plotly.purge("trendChart"); return; }
  const t=rows.map(r=>new Date(r.ts));
  const fabric=rows.map(r=>r.Meter_Run_Hourly);
  const runtime=rows.map(r=>r.Runtime_Hourly);
  const energy=rows.map(r=>r.Consumption_Hourly);
  const downtime=rows.map(r=>r.Downtime_Hourly);
  Plotly.newPlot("trendChart",[
    {x:t,y:fabric,name:"Fabric",mode:"lines",line:{color:"#38bdf8"}},
    {x:t,y:runtime,name:"Runtime",mode:"lines",line:{color:"#22c55e"}},
    {x:t,y:downtime,name:"Downtime",mode:"lines",line:{color:"#ef4444"}},
    {x:t,y:energy,name:"Energy",mode:"lines",line:{color:"#f59e0b"}}
  ],{
    paper_bgcolor:"#1e293b",
    plot_bgcolor:"#1e293b",
    font:{color:"#f1f5f9"},
    margin:{l:40,r:20,t:30,b:30},
    legend:{orientation:"h",y:-0.2}
  },{displaylogo:false,responsive:true});
}

async function init(){
  try{
    const json=await fetchHourlyData();
    const rows=mergeSeries(json);
    renderKpis(rows);
    renderTable(rows);
    renderChart(rows);
  }catch(e){
    console.error(e);
    alert("Failed to load data: "+e.message);
  }
}
window.addEventListener("load",init);
</script>
</body>
</html>
