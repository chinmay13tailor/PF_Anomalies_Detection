<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Low Power Factor Analysis Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;margin:0;color:#333}
    .page{padding:2rem}
    .header{display:flex;justify-content:space-between;flex-wrap:wrap;gap:1rem;border-bottom:1px solid #e5e7eb;padding-bottom:1rem}
    .company{font-weight:700;font-size:1.1rem}
    .meta{color:#555}
    .filter-row{width:95%;margin:1rem auto;display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;background:#fff;padding:1rem;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    label{font-weight:600;display:block;margin:0 0 .35rem}
    input,button{padding:.55rem .8rem;font-size:1rem;border:1px solid #d0d7de;border-radius:6px;background:#fff}
    button{background:#1363df;color:#fff;border:0;font-weight:700;cursor:pointer}
    button:hover{background:#0e4fb1}
    .status{margin-left:.5rem;color:#6a737d}
    .summary-row{width:95%;margin:1rem auto 0;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
    .kpi{background:#fff;border-radius:10px;padding:1rem 1.25rem;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .kpi .title{color:#666;font-size:.9rem}
    .kpi .value{font-size:2rem;font-weight:800}
    .kpi .sub{color:#666;margin-top:.25rem}
    .kpi.danger{background:#ffe0dd}
    .panel{width:95%;margin:1rem auto;background:#fff;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:1rem}
    .panel h3{margin:.2rem 0 1rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:.8rem 1rem;border-bottom:1px solid #eee;text-align:center}
    thead th{background:#ffd700;color:#222}
    tbody tr:nth-child(even){background:#fafafa}
    .footer{width:95%;margin:1rem auto 0;display:grid;grid-template-columns:2fr 1fr;gap:1rem}
    .footer textarea{width:100%;min-height:90px;border:1px solid #d0d7de;border-radius:8px;padding:.6rem}
    .sign .line{border-bottom:2px solid #333;height:28px;margin-top:24px}
    @media (max-width:980px){.summary-row{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="page">
  <!-- Header -->
  <div class="header">
    <div>
      <div class="company" id="companyName">Pima Controls Pvt Ltd</div>
      <div id="companyAddress">Ahmedabad, India</div>
    </div>
    <div class="meta">
      <div><b>Report:</b> Low Power Factor Analysis Report</div>
      <div><b>Report Date:</b> <span id="reportDateLabel">—</span></div>
      <div><b>Generated:</b> <span id="generatedAt">—</span></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="filter-row">
    <div>
      <label for="dateInput">Select Date</label>
      <input type="date" id="dateInput"/>
    </div>
    <div>
      <label for="deviceInput">Device ID</label>
      <input type="text" id="deviceInput" placeholder="Device UUID"/>
    </div>
    <div>
      <button id="btnGenerate">Generate</button>
      <span class="status" id="status">Idle</span>
    </div>
  </div>

  <!-- KPI row -->
  <div class="summary-row">
    <div class="kpi">
      <div class="title">Avg PF (window)</div>
      <div class="value" id="kpiAvgPF">—</div>
    </div>
    <div class="kpi">
      <div class="title">Min PF</div>
      <div class="value" id="kpiMinPF">—</div>
      <div class="sub" id="kpiMinPFTs">—</div>
    </div>
    <div class="kpi">
      <div class="title">Duration PF &lt; 0.90</div>
      <div class="value" id="kpiDurationLowPF">—</div>
    </div>
    <div class="kpi danger">
      <div class="title">Estimated penalty (₹)</div>
      <div class="value" id="kpiPenalty">—</div>
    </div>
  </div>

  <!-- PF Trend -->
  <div class="panel">
    <h3>PF Trend (with Active_Power & Reactive_Power)</h3>
    <div id="pfTrend" style="height:380px;"></div>
  </div>

  <!-- Energy + Scatter -->
  <div class="grid2">
    <div class="panel">
      <h3>Hourly kWh vs kVArh</h3>
      <div id="energyBars" style="height:360px;"></div>
    </div>
    <div class="panel">
      <h3>PF vs kW</h3>
      <div id="pfScatter" style="height:360px;"></div>
    </div>
  </div>

  <!-- Events -->
  <div class="panel">
    <h3>Events Table (PF &lt; 0.90)</h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Start</th><th>End</th><th>Min PF</th>
            <th>kW@minPF</th><th>kVAr@minPF</th><th>kVA@minPF</th><th>Duration (min)</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="eventsBody"><tr><td colspan="8">Click Generate</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div>
      <div><b>Remarks</b></div>
      <textarea placeholder="Engineer notes..."></textarea>
    </div>
    <div class="sign">
      <div>Reviewed by</div><div class="line"></div>
      <div style="height:10px"></div>
      <div>Checked by</div><div class="line"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  COMPANY_NAME: "Pima Controls Pvt Ltd",
  COMPANY_ADDRESS: "Ahmedabad, India",
  API_BASE_URL: "https://plantwiz.pimateck.in/api",   // << your base
  PF_TARGET: 0.95,
  LOW_PF_THRESHOLD: 0.90,
  DEMAND_RATE_INR_PER_KVA: 350,
  DEFAULT_DEVICE_ID: "a41ff8c0-ce7c-11ef-826c-29d63551db41",
  // Your exact keys:
  KEYS: [
    "Active_Power",
    "Apparent_Power",
    "Reactive_Power",
    "Power_Factor",
    "PrrMinConsumption",
    "Apparent_Energy",
    "Reactive_Energy"
  ]
};
/* =============== */

const qs = new URLSearchParams(location.search);
const JWT = qs.get("token") || "";
const URL_DEVICE = qs.get("deviceId") || "";

document.getElementById("companyName").textContent = CONFIG.COMPANY_NAME;
document.getElementById("companyAddress").textContent = CONFIG.COMPANY_ADDRESS;

const today = new Date();
const pad = n => String(n).padStart(2,"0");
const defDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
document.getElementById("dateInput").value = defDate;
document.getElementById("reportDateLabel").textContent = defDate;
document.getElementById("generatedAt").textContent = new Date().toLocaleString();
document.getElementById("deviceInput").value = URL_DEVICE || CONFIG.DEFAULT_DEVICE_ID;

document.getElementById("btnGenerate").addEventListener("click", generate);

function fmtTs(t){ return new Date(t).toLocaleString(); }
function isF(v){ return Number.isFinite(v); }
function num(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }

/* FETCH — same style as your reference (agg=NONE) */
async function fetchTS(deviceId, keysCsv, startTs, endTs){
  const url = `${CONFIG.API_BASE_URL}/plugins/telemetry/DEVICE/${deviceId}/values/timeseries` +
              `?keys=${encodeURIComponent(keysCsv)}&startTs=${startTs}&endTs=${endTs}&limit=50000&agg=NONE`;
  const headers = JWT ? { "X-Authorization": `Bearer ${JWT}` } : {};
  const res = await fetch(url, { headers });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

/* Merge TB response into aligned rows */
function mergeSeries(obj){
  const map = new Map();
  Object.entries(obj).forEach(([key,arr])=>{
    (arr||[]).forEach(p=>{
      const t = +p.ts;
      const row = map.get(t) || { ts: t };
      row[key] = num(p.value);
      map.set(t,row);
    });
  });
  return Array.from(map.values()).sort((a,b)=>a.ts-b.ts);
}

/* Light smoothing for PF */
function smoothPF(rows, n=5){
  const q=[]; let sum=0;
  for (let i=0;i<rows.length;i++){
    const v = rows[i].PF;
    if (isF(v)){ q.push(v); sum+=v; if(q.length>n){ sum-=q.shift(); } rows[i].PF = sum/q.length; }
  }
}

/* Hourly aggregates:
   - kWh = sum of PrrMinConsumption in the hour
   - kVArh = (max - min) of Reactive_Energy (cumulative) in the hour
*/
function hourlyEnergyFromRows(rows){
  const byHour = new Map();
  rows.forEach(r=>{
    const d = new Date(r.ts);
    const bucket = new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours()).getTime();
    const obj = byHour.get(bucket) || { ts: bucket, perMin: [], reactiveList: [] };
    if (isF(r.PrrMinConsumption)) obj.perMin.push(r.PrrMinConsumption);
    if (isF(r.Reactive_Energy)) obj.reactiveList.push(r.Reactive_Energy);
    byHour.set(bucket, obj);
  });
  const out = Array.from(byHour.values()).map(h=>{
    const kWh = h.perMin.reduce((s,x)=>s+x, 0);
    let kVArh = 0;
    if (h.reactiveList.length >= 2){
      const maxv = Math.max(...h.reactiveList);
      const minv = Math.min(...h.reactiveList);
      kVArh = Math.max(0, maxv - minv);
    }
    return { ts: h.ts, kWh, kVArh };
  }).sort((a,b)=>a.ts-b.ts);
  return out;
}

/* Detect PF < threshold contiguous events */
function detectLowPFEvents(rows, thr){
  const events=[]; let cur=null;
  for (let i=0;i<rows.length;i++){
    const r = rows[i];
    const low = isF(r.PF) && r.PF < thr;
    if (low && !cur){
      cur = { startTs:r.ts, minPF:r.PF, at:r.ts, kW:r.kW, kVAr:r.kVAr, kVA:r.kVA };
    }
    if (low && cur && r.PF < cur.minPF){
      cur.minPF = r.PF; cur.at = r.ts; cur.kW = r.kW; cur.kVAr = r.kVAr; cur.kVA = r.kVA;
    }
    if (!low && cur){
      cur.endTs = rows[i-1]?.ts ?? r.ts;
      events.push(cur); cur=null;
    }
  }
  if (cur){ cur.endTs = rows.at(-1)?.ts ?? cur.startTs; events.push(cur); }
  events.forEach(e=> e.durationMin = Math.max(1, Math.round((e.endTs - e.startTs)/60000)) );
  return events;
}

/* Penalty estimate (simple proportional method) */
function estimatePenalty(rows){
  let penalty = 0;
  for (let i=1;i<rows.length;i++){
    const a=rows[i-1], b=rows[i];
    const dtDay = (b.ts - a.ts) / (24*3600*1000);
    const PF = b.PF ?? a.PF;
    const kVA = isF(b.kVA) ? b.kVA : (isF(a.kVA) ? a.kVA : 0);
    if (isF(PF) && PF < CONFIG.LOW_PF_THRESHOLD && isF(kVA)){
      const delta = Math.max(0, (1/PF) - (1/CONFIG.PF_TARGET));
      penalty += kVA * delta * CONFIG.DEMAND_RATE_INR_PER_KVA * dtDay;
    }
  }
  return Math.round(penalty);
}

/* Rendering */
function renderKPIs(rows, events){
  const pfs = rows.map(r=>r.PF).filter(isF);
  const avg = pfs.length ? pfs.reduce((s,x)=>s+x,0)/pfs.length : NaN;
  const minPF = pfs.length ? Math.min(...pfs) : NaN;
  const minIdx = pfs.length ? pfs.indexOf(minPF) : -1;
  const minTs  = minIdx>=0 ? rows[minIdx].ts : null;
  const lowDur = events.reduce((s,e)=>s+e.durationMin,0);
  const penalty = estimatePenalty(rows);

  document.getElementById("kpiAvgPF").textContent = isF(avg)?avg.toFixed(2):"—";
  document.getElementById("kpiMinPF").textContent = isF(minPF)?minPF.toFixed(2):"—";
  document.getElementById("kpiMinPFTs").textContent = minTs?fmtTs(minTs):"—";
  document.getElementById("kpiDurationLowPF").textContent = `${lowDur} min`;
  document.getElementById("kpiPenalty").textContent = penalty.toLocaleString();
}

function renderPFTrend(rows){
  const el = document.getElementById("pfTrend");
  if (!rows.length){ el.innerHTML = '<div style="text-align:center;padding:2rem;color:#666">No data</div>'; return; }
  const t   = rows.map(r=>new Date(r.ts));
  const pf  = rows.map(r=>r.PF);
  const kw  = rows.map(r=>r.kW);
  const kvar= rows.map(r=>r.kVAr);

  Plotly.newPlot("pfTrend", [
    {x:t, y:pf,   name:"Power Factor", mode:"lines", line:{width:2}},
    {x:t, y:kvar, name:"Reactive Power (kVAr)", mode:"lines", yaxis:"y2"},
    {x:t, y:kw,   name:"Active Power (kW)",    mode:"lines", yaxis:"y2"}
  ], {
    margin:{l:50,r:60,t:10,b:30},
    yaxis:{title:"PF", range:[0,1.2]},
    yaxis2:{title:"kW / kVAr", overlaying:"y", side:"right"},
    shapes:[
      {type:"line", x0:t[0], x1:t.at(-1), y0:0.95, y1:0.95, line:{dash:"dot", color:"#f1c40f"}},
      {type:"line", x0:t[0], x1:t.at(-1), y0:0.90, y1:0.90, line:{dash:"dot", color:"#e74c3c"}}
    ],
    legend:{orientation:"h"}
  }, {displaylogo:false,responsive:true});
}

function renderEnergyBars(hourly){
  const el = document.getElementById("energyBars");
  if (!hourly.length){ el.innerHTML = '<div style="text-align:center;padding:2rem;color:#666">No data</div>'; return; }
  const x = hourly.map(h=>new Date(h.ts));
  Plotly.newPlot("energyBars", [
    {x, y: hourly.map(h=>h.kWh),  name:"kWh (sum of PrrMinConsumption)",  type:"bar"},
    {x, y: hourly.map(h=>h.kVArh),name:"kVArh (Δ Reactive_Energy)", type:"bar"}
  ], {barmode:"group", margin:{l:40,r:10,t:10,b:30}}, {displaylogo:false,responsive:true});
}

function renderScatter(rows){
  const el = document.getElementById("pfScatter");
  if (!rows.length){ el.innerHTML = '<div style="text-align:center;padding:2rem;color:#666">No data</div>'; return; }
  const x = rows.map(r=>r.kW);
  const y = rows.map(r=>r.PF);
  Plotly.newPlot("pfScatter", [{x,y,mode:"markers",name:"PF vs kW"}],
    {margin:{l:40,r:10,t:10,b:40}, xaxis:{title:"kW"}, yaxis:{title:"PF", range:[0,1]}},
    {displaylogo:false,responsive:true});
}

function renderEvents(events){
  const tb = document.getElementById("eventsBody");
  tb.innerHTML = "";
  if (!events.length){ tb.innerHTML = '<tr><td colspan="8">No low PF events</td></tr>'; return; }
  events.forEach(e=>{
    const tr = document.createElement("tr");
    [fmtTs(e.startTs), fmtTs(e.endTs), e.minPF.toFixed(2),
     (e.kW??0).toFixed(0), (e.kVAr??0).toFixed(0), (e.kVA??0).toFixed(0),
     e.durationMin, ""].forEach(v=>{
      const td=document.createElement("td"); td.textContent=v; tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

/* Main Generate */
async function generate(){
  const dateStr = document.getElementById("dateInput").value;
  const deviceId = (document.getElementById("deviceInput").value || "").trim();
  if (!deviceId){ alert("Please enter Device ID"); return; }
  if (!JWT){ alert("Missing token in URL (?token=)"); return; }

  document.getElementById("status").textContent = "Fetching…";
  document.getElementById("reportDateLabel").textContent = dateStr;
  document.getElementById("generatedAt").textContent = new Date().toLocaleString();

  const start = new Date(dateStr+"T00:00:00");
  const end   = new Date(dateStr+"T23:59:59");

  try{
    // Fetch all keys in one call (agg=NONE), just like your reference
    const json = await fetchTS(
      deviceId,
      CONFIG.KEYS.join(","),
      start.getTime(),
      end.getTime()
    );

    // Align & derive
    const rows = mergeSeries(json).map(r=>{
      const kW   = num(r.Active_Power);
      const kVAr = num(r.Reactive_Power);
      const kVA  = isF(r.Apparent_Power) ? r.Apparent_Power :
                   (isF(kW)&&isF(kVAr)) ? Math.sqrt(kW*kW + kVAr*kVAr) : NaN;
      const pf   = isF(r.Power_Factor) ? r.Power_Factor :
                   (isF(kW)&&isF(kVA)&&kVA>0 ? kW/kVA : NaN);
      return {
        ts: r.ts,
        kW, kVAr, kVA,
        PF: pf,
        PrrMinConsumption: num(r.PrrMinConsumption),
        Reactive_Energy: num(r.Reactive_Energy),
        Apparent_Energy: num(r.Apparent_Energy)
      };
    });

    // Smooth PF
    smoothPF(rows, 5);

    // Hourly energy
    const hourly = hourlyEnergyFromRows(rows);

    // Low PF events
    const events = detectLowPFEvents(rows, CONFIG.LOW_PF_THRESHOLD);

    // Render
    renderKPIs(rows, events);
    renderPFTrend(rows);
    renderEnergyBars(hourly);
    renderScatter(rows);
    renderEvents(events);

    document.getElementById("status").textContent = "Done";
  }catch(err){
    console.error(err);
    document.getElementById("status").textContent = "Error";
    alert("Failed to fetch/build report.\n" + err.message);
  }
}

// Auto-run when token + a device is available
window.addEventListener("load", ()=>{
  if (JWT && (URL_DEVICE || CONFIG.DEFAULT_DEVICE_ID)){
    if (!URL_DEVICE) document.getElementById("deviceInput").value = CONFIG.DEFAULT_DEVICE_ID;
    generate();
  }
});
</script>
</body>
</html>
